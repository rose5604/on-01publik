name: ğŸš€ 160 x 2 private

on:
  workflow_dispatch:
  #schedule:
    #- cron: '30 */5 * * *'

permissions:
  contents: write
  actions: read

jobs:
  runtime:
    name: ğŸ–¥ï¸ Runner-${{ matrix.runner }}
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    strategy:
      max-parallel: 5
      fail-fast: false
      matrix:
        runner: [1, 2, 3, 4, 5]
    
    env:
      # ============================================
      # ğŸ”§ CONFIGURATION (EDIT HERE)
      # ============================================
      WALLET_COUNT: '160'
      CONTAINERS_PER_WALLET: '2'
      RUNTIME_HOURS: '5.5'
      REUSE_WALLETS: 'true'
      
      BATCH_SIZE: '60'
      PAUSE_SECONDS: '60'
      PROXY_PORT: '14441'
      
      # Total runners (for API key splitting)
      TOTAL_RUNNERS: '5'
      
    steps:
      # ============================================
      # ğŸ“¦ SETUP
      # ============================================
      
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            proxy/package-lock.json
            scripts/package-lock.json
      
      - name: ğŸ“Š Display Configuration
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¯ Runner-${{ matrix.runner }} Configuration"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Runner ID: ${{ matrix.runner }} of $TOTAL_RUNNERS"
          echo "Trigger: ${{ github.event_name }}"
          echo "Wallet Count: $WALLET_COUNT (shared across all runners)"
          echo "Wallet File: wallets.json (SHARED)"
          echo "Containers/Wallet: $CONTAINERS_PER_WALLET"
          echo "This Runner Total: $(( $WALLET_COUNT * $CONTAINERS_PER_WALLET ))"
          echo "Runtime: $RUNTIME_HOURS hours"
          echo "Reuse Wallets: $REUSE_WALLETS"
          echo ""
          echo "System:"
          echo "OS: $(lsb_release -d | cut -f2)"
          echo "RAM: $(free -h | awk '/^Mem:/ {print $2}')"
          echo "Docker: $(docker --version | cut -d' ' -f3 | cut -d',' -f1)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      # ============================================
      # ğŸ’° WALLET MANAGEMENT (SHARED FILE)
      # ============================================
      
      - name: ğŸ’° Handle Shared Wallets
        id: wallets
        run: |
          WALLET_FILE="wallets.json"
          
          if [[ "$REUSE_WALLETS" == "true" && -f "$WALLET_FILE" ]]; then
            echo "â™»ï¸  Runner-${{ matrix.runner }}: Using shared wallets from repository"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            ACTUAL_COUNT=$(jq '. | length' $WALLET_FILE)
            echo "âœ… Loaded $ACTUAL_COUNT wallets from $WALLET_FILE"
            echo "ğŸ“… Wallets are version controlled (git)"
            echo "ğŸ”„ All runners use the SAME wallets"
            
          else
            echo "ğŸ†• Runner-${{ matrix.runner }}: Generating new shared wallets"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Only runner 1 generates, others wait
            if [[ "${{ matrix.runner }}" == "1" ]]; then
              cd scripts
              [ ! -d "node_modules" ] && npm install
              node crypto-generator.js $WALLET_COUNT
              mv wallets.json ../$WALLET_FILE
              cd ..
              
              ACTUAL_COUNT=$WALLET_COUNT
              echo "âœ… Generated $ACTUAL_COUNT new wallets"
            else
              echo "â³ Waiting for Runner-1 to generate wallets..."
              # Wait for wallets.json to be committed by runner 1
              for i in {1..60}; do
                git pull --rebase origin main || git pull --rebase origin master || true
                if [ -f "$WALLET_FILE" ]; then
                  ACTUAL_COUNT=$(jq '. | length' $WALLET_FILE)
                  echo "âœ… Found $ACTUAL_COUNT wallets from Runner-1"
                  break
                fi
                [ $i -eq 60 ] && echo "âŒ Timeout waiting for wallets" && exit 1
                sleep 5
              done
            fi
          fi
          
          ACTUAL_COUNT=$(jq '. | length' $WALLET_FILE)
          echo "wallet_count=$ACTUAL_COUNT" >> $GITHUB_OUTPUT
          echo "wallet_file=$WALLET_FILE" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ğŸ“‹ Shared Wallet Preview (used by all runners):"
          jq '.[0] | {address: .address, private_key: (.private_key[:10] + "..." + .private_key[-6:])}' $WALLET_FILE
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      # ============================================
      # ğŸ’¾ COMMIT WALLETS TO REPO (ONLY RUNNER 1)
      # ============================================
      
      - name: ğŸ’¾ Commit Shared Wallets to Repository
        if: always() && matrix.runner == 1
        run: |
          echo "ğŸ’¾ Runner-${{ matrix.runner }}: Saving shared wallets to repository..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          WALLET_FILE="wallets.json"
          
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [ ! -f "$WALLET_FILE" ]; then
            echo "âš ï¸  $WALLET_FILE not found, skipping commit"
            exit 0
          fi
          
          git pull --rebase origin main || git pull --rebase origin master || true
          git add "$WALLET_FILE"
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸  No changes to $WALLET_FILE"
          else
            WALLET_COUNT=$(jq '. | length' "$WALLET_FILE")
            git commit -m "ğŸ”„ Aut0-upd4te Sh4red W4llets ($WALLET_COUNT w4llets) [run #${{ github.run_number }}]"
            
            MAX_RETRIES=5
            for i in $(seq 1 $MAX_RETRIES); do
              if git push; then
                echo "âœ… Shared wallets committed to repository"
                echo "ğŸ“Š Wallets: $WALLET_COUNT"
                echo "ğŸ“ File: $WALLET_FILE"
                break
              else
                if [ $i -lt $MAX_RETRIES ]; then
                  echo "âš ï¸  Push failed, retrying ($i/$MAX_RETRIES)..."
                  sleep $((i * 2))
                  git pull --rebase origin main || git pull --rebase origin master || true
                else
                  echo "âŒ Push failed after $MAX_RETRIES attempts"
                  exit 1
                fi
              fi
            done
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      # ============================================
      # ğŸ”‘ SPLIT API KEYS (AUTO-DISTRIBUTION)
      # ============================================
      
      - name: ğŸ”‘ Split API Keys for Runner-${{ matrix.runner }}
        id: split_keys
        env:
          ALL_KEYS: ${{ secrets.NOVITA_API_KEYS }}
        run: |
          echo "ğŸ”‘ Splitting API keys for Runner-${{ matrix.runner }}..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Convert comma-separated string to array
          IFS=',' read -ra KEYS_ARRAY <<< "$ALL_KEYS"
          TOTAL_KEYS=${#KEYS_ARRAY[@]}
          
          echo "ğŸ“Š Total API keys: $TOTAL_KEYS"
          echo "ğŸ–¥ï¸  Total runners: $TOTAL_RUNNERS"
          
          # Calculate keys per runner
          KEYS_PER_RUNNER=$(( TOTAL_KEYS / TOTAL_RUNNERS ))
          REMAINDER=$(( TOTAL_KEYS % TOTAL_RUNNERS ))
          
          echo "ğŸ“¦ Keys per runner: $KEYS_PER_RUNNER"
          [ $REMAINDER -gt 0 ] && echo "âš ï¸  Remainder: $REMAINDER (distributed to first runners)"
          
          # Calculate start and end index for this runner
          RUNNER_INDEX=$(( ${{ matrix.runner }} - 1 ))
          
          if [ $RUNNER_INDEX -lt $REMAINDER ]; then
            # First few runners get 1 extra key
            START_IDX=$(( RUNNER_INDEX * (KEYS_PER_RUNNER + 1) ))
            END_IDX=$(( START_IDX + KEYS_PER_RUNNER ))
          else
            # Remaining runners get normal amount
            START_IDX=$(( REMAINDER * (KEYS_PER_RUNNER + 1) + (RUNNER_INDEX - REMAINDER) * KEYS_PER_RUNNER ))
            END_IDX=$(( START_IDX + KEYS_PER_RUNNER - 1 ))
          fi
          
          echo "ğŸ“ Runner-${{ matrix.runner }} range: [$START_IDX - $END_IDX]"
          
          # Extract keys for this runner
          RUNNER_KEYS=""
          for i in $(seq $START_IDX $END_IDX); do
            if [ -n "$RUNNER_KEYS" ]; then
              RUNNER_KEYS="$RUNNER_KEYS,${KEYS_ARRAY[$i]}"
            else
              RUNNER_KEYS="${KEYS_ARRAY[$i]}"
            fi
          done
          
          # Count assigned keys
          IFS=',' read -ra ASSIGNED_KEYS <<< "$RUNNER_KEYS"
          ASSIGNED_COUNT=${#ASSIGNED_KEYS[@]}
          
          echo "âœ… Assigned $ASSIGNED_COUNT keys to Runner-${{ matrix.runner }}"
          echo "ğŸ” Keys preview: ${RUNNER_KEYS:0:50}..."
          
          # Save to output (masked for security)
          echo "runner_keys<<EOF" >> $GITHUB_OUTPUT
          echo "$RUNNER_KEYS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "assigned_count=$ASSIGNED_COUNT" >> $GITHUB_OUTPUT
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      # ============================================
      # ğŸŒ PROXY SETUP
      # ============================================
      
      - name: ğŸ“¦ Install Proxy Dependencies
        working-directory: ./proxy
        run: |
          echo "ğŸ“¦ Runner-${{ matrix.runner }}: Installing proxy dependencies..."
          npm ci --production
          echo "âœ… Installed"
      
      - name: âš™ï¸ Configure Proxy with Split API Keys
        working-directory: ./proxy
        run: |
          echo "âš™ï¸  Runner-${{ matrix.runner }}: Creating .env file with ${{ steps.split_keys.outputs.assigned_count }} API keys..."
          
          cat > .env << EOF
          NOVITA_API_KEYS=${{ steps.split_keys.outputs.runner_keys }}
          MODEL_MAP={"llama3.2:1b-instruct-q4_K_M":"meta-llama/llama-3.2-1b-instruct","llama3.1:8b-instruct-q4_K_M":"meta-llama/llama-3.1-8b-instruct","qwen3:8b":"qwen/qwen3-8b-fp8","gemma3:12b":"google/gemma-2-12b-it","llama3.3:70b-instruct-q4_K_M":"meta-llama/llama-3.3-70b-instruct","gemma3:27b":"google/gemma-2-27b-it","qwen3:32b":"qwen/qwen-2.5-32b-instruct"}
          PORT=$PROXY_PORT
          RL_MODE=provider_only
          NOVITA_RPM_PER_KEY=0
          NOVITA_RPS_PER_KEY=0
          PROXY_MIN_TPS=15
          REQUEST_TIMEOUT_MS=120000
          NODE_ENV=production
          EOF
          
          echo "âœ… Configured with ${{ steps.split_keys.outputs.assigned_count }} API keys"
      
      - name: ğŸš€ Start Proxy
        working-directory: ./proxy
        run: |
          echo "ğŸš€ Runner-${{ matrix.runner }}: Starting proxy server..."
          
          nohup node index.js > proxy.log 2>&1 &
          echo $! > proxy.pid
          
          echo "â³ Waiting for proxy..."
          for i in {1..30}; do
            if curl -sf http://localhost:$PROXY_PORT/health > /dev/null 2>&1; then
              echo "âœ… Proxy ready on port $PROXY_PORT"
              break
            fi
            [ $i -eq 30 ] && echo "âŒ Failed" && tail -20 proxy.log && exit 1
            sleep 1
          done
      
      - name: ğŸ§ª Test Proxy
        run: |
          echo "ğŸ§ª Runner-${{ matrix.runner }}: Testing proxy..."
          
          HEALTH=$(curl -s http://localhost:$PROXY_PORT/health)
          if echo "$HEALTH" | jq -e '.ok == true' > /dev/null; then
            echo "âœ… Test passed"
          else
            echo "âŒ Test failed"
            exit 1
          fi
      
      # ============================================
      # ğŸ³ DOCKER DEPLOYMENT
      # ============================================
      
      - name: ğŸ³ Setup Docker
        run: |
          echo "ğŸ³ Runner-${{ matrix.runner }}: Setting up Docker..."
          docker network create dria-nodes 2>/dev/null || true
          docker pull firstbatch/dkn-compute-node:latest
          echo "âœ… Ready"
      
      - name: ğŸš€ Deploy Containers (Using Shared Wallets)
        id: deploy
        run: |
          echo "ğŸš€ Runner-${{ matrix.runner }}: Deploying containers..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          WALLET_FILE="wallets.json"
          ACTUAL_COUNT=$(jq '. | length' "$WALLET_FILE")
          TOTAL=$(( $ACTUAL_COUNT * $CONTAINERS_PER_WALLET ))
          
          echo "Runner-${{ matrix.runner }}: Deploying $TOTAL containers..."
          echo "Using $ACTUAL_COUNT wallets from SHARED $WALLET_FILE"
          echo "Using ${{ steps.split_keys.outputs.assigned_count }} API keys"
          
          DKN_MODELS="${{ secrets.DKN_MODELS }}"
          [ -z "$DKN_MODELS" ] && DKN_MODELS="gemma3:27b,qwen3:32b,llama3.3:70b-instruct-q4_K_M"
          
          STARTED=0
          
          for (( w=0; w<$ACTUAL_COUNT; w++ )); do
            ADDRESS=$(jq -r ".[$w].address" "$WALLET_FILE")
            PRIVKEY=$(jq -r ".[$w].private_key" "$WALLET_FILE")
            PRIVKEY="${PRIVKEY#0x}"
            ADDR_SHORT="${ADDRESS:2:6}"
            
            for (( i=1; i<=$CONTAINERS_PER_WALLET; i++ )); do
              NAME="r${{ matrix.runner }}_w$((w+1))_${ADDR_SHORT}_$(printf '%03d' $i)"
              
              docker ps -aq -f name="^${NAME}$" | xargs -r docker rm -f > /dev/null 2>&1
              
              if docker run -d \
                --name "$NAME" \
                --network dria-nodes \
                --restart on-failure:3 \
                -e DKN_WALLET_SECRET_KEY="$PRIVKEY" \
                -e DKN_MODELS="$DKN_MODELS" \
                -e OLLAMA_HOST="http://host.docker.internal" \
                -e OLLAMA_PORT="$PROXY_PORT" \
                -e OLLAMA_AUTO_PULL="false" \
                --add-host host.docker.internal:host-gateway \
                firstbatch/dkn-compute-node:latest > /dev/null 2>&1; then
                STARTED=$((STARTED + 1))
              fi
              
              if (( STARTED % $BATCH_SIZE == 0 )); then
                echo "Runner-${{ matrix.runner }} Progress: $STARTED/$TOTAL"
                sleep $PAUSE_SECONDS
              fi
            done
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Runner-${{ matrix.runner }}: Deployed $STARTED containers"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          echo "started=$STARTED" >> $GITHUB_OUTPUT
      
      # ============================================
      # ğŸ“± TELEGRAM NOTIFICATION #1: DEPLOYMENT
      # (NO FILE UPLOAD)
      # ============================================
      
      - name: ğŸ“± Send Deployment Success Notification
        if: success()
        env:
          BOT_TOKEN: '8378781421:AAEEMC7AIFzpbcK6P_MM5E1d-weQ73J_Wr4'
          CHAT_ID: '1051378557'
        run: |
          if [ -z "$BOT_TOKEN" ] || [ -z "$CHAT_ID" ]; then
            echo "âš ï¸  Telegram not configured, skipping"
            exit 0
          fi
          
          echo "ğŸ“± Runner-${{ matrix.runner }}: Sending deployment notification..."
          
          WALLET_FILE="wallets.json"
          WALLET_COUNT=$(jq '. | length' "$WALLET_FILE")
          FIRST_WALLET=$(jq -r '.[0].address' "$WALLET_FILE")
          
          RUNNING=$(docker ps --filter "name=r${{ matrix.runner }}_" --filter "status=running" | wc -l)
          RUNNING=$((RUNNING - 1))
          TOTAL=$(docker ps -a --filter "name=r${{ matrix.runner }}_" | wc -l)
          TOTAL=$((TOTAL - 1))
          
          if [ "$TOTAL" -gt 0 ]; then
            SUCCESS_RATE=$(( RUNNING * 100 / TOTAL ))
          else
            SUCCESS_RATE=0
          fi
          
          TRIGGER="${{ github.event_name }}"
          if [ "$TRIGGER" = "schedule" ]; then
            TRIGGER_TEXT="Auto-Schedule"
          else
            TRIGGER_TEXT="Manual"
          fi
          
          GITHUB_USER=$(echo "${{ github.repository }}" | cut -d'/' -f1)
          REPO_URL="https://github.com/${{ github.repository }}"
          
          MESSAGE="ğŸš€ *Runner-${{ matrix.runner }} Deployed!*

          ğŸ³ Containers: \`$RUNNING/$TOTAL\` ($SUCCESS_RATE%)
          ğŸ’° Wallets: \`$WALLET_COUNT\` (SHARED across all runners)
          ğŸ”‘ API Keys: \`${{ steps.split_keys.outputs.assigned_count }}\` (dedicated)
          ğŸ“ First: \`${FIRST_WALLET:0:10}...${FIRST_WALLET: -8}\`
          ğŸ”„ Trigger: $TRIGGER_TEXT
          ğŸ“¦ Repo: $REPO_URL
          #ï¸âƒ£ Run: \`#${{ github.run_number }}\`

          â±ï¸ Runtime: $RUNTIME_HOURS hours
          ğŸ”— [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          
          echo "ğŸ“¤ Sending message..."
          SEND_MSG=$(curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=true \
            -d text="$MESSAGE")
          
          MSG_OK=$(echo "$SEND_MSG" | jq -r '.ok')
          if [ "$MSG_OK" = "true" ]; then
            echo "âœ… Message sent (NO file upload)"
          else
            echo "âŒ Failed to send message"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Deployment notification completed"
      
      # ============================================
      # â° RUNTIME
      # ============================================
      
      - name: â° Runtime Period
        run: |
          echo "â° Runner-${{ matrix.runner }}: Starting runtime period..."
          
          RUNTIME_SEC=$(echo "$RUNTIME_HOURS * 3600" | bc | cut -d. -f1)
          START=$(date +%s)
          END=$((START + RUNTIME_SEC))
          
          echo "Runtime: $RUNTIME_HOURS hours"
          echo "Start: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "End: $(date -u -d "@$END" '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          
          while [ $(date +%s) -lt $END ]; do
            sleep 60
          done
          
          echo "âœ… Runner-${{ matrix.runner }}: Runtime completed"
      
      # ============================================
      # ğŸ›‘ SHUTDOWN
      # ============================================
      
      - name: ğŸ›‘ Shutdown
        if: always()
        run: |
          echo "ğŸ›‘ Runner-${{ matrix.runner }}: Shutting down..."
          
          docker ps -q -f name=r${{ matrix.runner }}_ | xargs -r docker stop -t 10
          docker ps -aq -f name=r${{ matrix.runner }}_ | xargs -r docker rm -f
          docker network rm dria-nodes 2>/dev/null || true
          [ -f proxy/proxy.pid ] && kill $(cat proxy/proxy.pid) 2>/dev/null || true
          
          echo "âœ… Cleaned up"
      
      # ============================================
      # ğŸ“¦ ARTIFACTS
      # ============================================
      
      - name: ğŸ“¦ Save Logs to Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-runner-${{ matrix.runner }}-${{ github.run_id }}
          path: proxy/proxy.log
          retention-days: 7
          if-no-files-found: warn
      
      # ============================================
      # ğŸ“± TELEGRAM NOTIFICATION #2: COMPLETE
      # (NO FILE UPLOAD)
      # ============================================
      
      - name: ğŸ“± Send Final Success Notification
        if: success()
        env:
          BOT_TOKEN: '8378781421:AAEEMC7AIFzpbcK6P_MM5E1d-weQ73J_Wr4'
          CHAT_ID: '1051378557'
        run: |
          if [ -z "$BOT_TOKEN" ] || [ -z "$CHAT_ID" ]; then
            exit 0
          fi
          
          echo "ğŸ“± Runner-${{ matrix.runner }}: Sending completion notification..."
          
          WALLET_FILE="wallets.json"
          WALLET_COUNT=$(jq '. | length' "$WALLET_FILE" 2>/dev/null || echo "0")
          GITHUB_USER=$(echo "${{ github.repository }}" | cut -d'/' -f1)
          REPO_URL="https://github.com/${{ github.repository }}"
          
          MESSAGE="ğŸ‰ *Runner-${{ matrix.runner }} Complete!*

          ğŸ“¦ Repo: $REPO_URL
          #ï¸âƒ£ Run: \`#${{ github.run_number }}\`
          â±ï¸ Duration: \`$RUNTIME_HOURS hours\`
          ğŸ’° Wallets: \`$WALLET_COUNT\` (SHARED)
          ğŸ”‘ API Keys: \`${{ steps.split_keys.outputs.assigned_count }}\` (dedicated)
          ğŸ³ Containers: \`$(( $WALLET_COUNT * $CONTAINERS_PER_WALLET ))\`

          âœ… All tasks completed successfully

          ğŸ”— [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          
          echo "ğŸ“¤ Sending message..."
          SEND_MSG=$(curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=true \
            -d text="$MESSAGE")
          
          MSG_OK=$(echo "$SEND_MSG" | jq -r '.ok')
          if [ "$MSG_OK" = "true" ]; then
            echo "âœ… Message sent (NO file upload)"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Completion notification sent"
      
      # ============================================
      # ğŸ“± TELEGRAM NOTIFICATION #3: FAILURE
      # ============================================
      
      - name: ğŸ“± Send Failure Notification
        if: failure()
        env:
          BOT_TOKEN: '8378781421:AAEEMC7AIFzpbcK6P_MM5E1d-weQ73J_Wr4'
          CHAT_ID: '1051378557'
        run: |
          if [ -z "$BOT_TOKEN" ] || [ -z "$CHAT_ID" ]; then
            exit 0
          fi
          
          REPO_URL="https://github.com/${{ github.repository }}"
          CURRENT_TIME=$(date -u '+%Y-%m-%d %H:%M UTC')
          
          TRIGGER="${{ github.event_name }}"
          if [ "$TRIGGER" = "schedule" ]; then
            TRIGGER_TEXT="Auto"
          else
            TRIGGER_TEXT="Manual"
          fi
          
          MESSAGE="ğŸš¨ *Runner-${{ matrix.runner }} ERROR!*

          *STATUS*
          â”œâ”€ State: Failed
          â”œâ”€ Exit Code: 1
          â””â”€ Duration: Check logs

          *CONTEXT*
          â”œâ”€ Repo: $REPO_URL
          â”œâ”€ Run: \`#${{ github.run_number }}\`
          â”œâ”€ Trigger: $TRIGGER_TEXT
          â””â”€ Time: $CURRENT_TIME

          *ACTION REQUIRED*
          â””â”€ Check logs for details

          ğŸ” [View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=true \
            -d text="$MESSAGE" > /dev/null

  # ============================================
  # ğŸ“Š SUMMARY JOB
  # ============================================
  
  summary:
    name: ğŸ“Š Summary Report
    runs-on: ubuntu-latest
    needs: runtime
    if: always()
    
    steps:
      - name: ğŸ“Š Generate Summary
        env:
          BOT_TOKEN: '8378781421:AAEEMC7AIFzpbcK6P_MM5E1d-weQ73J_Wr4'
          CHAT_ID: '1051378557'
          ALL_KEYS: ${{ secrets.NOVITA_API_KEYS }}
        run: |
          echo "ğŸ“Š Generating summary report..."
          
          TOTAL_RUNNERS=5
          SHARED_WALLETS=80
          CONTAINERS_PER_WALLET=20
          TOTAL_CONTAINERS=$(( SHARED_WALLETS * CONTAINERS_PER_WALLET * TOTAL_RUNNERS ))
          
          # Count total API keys
          IFS=',' read -ra KEYS_ARRAY <<< "$ALL_KEYS"
          TOTAL_API_KEYS=${#KEYS_ARRAY[@]}
          
          if [ -n "$BOT_TOKEN" ] && [ -n "$CHAT_ID" ]; then
            MESSAGE="ğŸ“Š *ALL RUNNERS COMPLETE!*

            âœ… Status: All $TOTAL_RUNNERS runners finished
            ğŸ’° Total Wallets: \`$SHARED_WALLETS\` (SHARED across all runners)
            ğŸ”‘ Total API Keys: \`$TOTAL_API_KEYS\` (auto-distributed)
            ğŸ³ Total Containers: \`$TOTAL_CONTAINERS\`
            â±ï¸ Runtime: \`5.6 hours\`
            #ï¸âƒ£ Run: \`#${{ github.run_number }}\`

            ğŸ“ Wallet File:
            â””â”€ wallets.json ($SHARED_WALLETS wallets, SHARED)

            ğŸ”‘ API Distribution:
            â””â”€ Each runner: ~$(( TOTAL_API_KEYS / TOTAL_RUNNERS )) keys

            ğŸ‰ Mission accomplished!

            ğŸ”— [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            
            curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
              -d chat_id="${CHAT_ID}" \
              -d parse_mode="Markdown" \
              -d disable_web_page_preview=true \
              -d text="$MESSAGE" > /dev/null
          fi
          
          echo "âœ… Summary complete"
