# ============================================
# ðŸ—‘ï¸ AUTO DELETE REPOSITORY WORKFLOW
# ============================================
# Workflow ini berjalan setelah workflow utama (160-2.yml) selesai
# 
# FITUR:
# - Backup repository ke artifact sebelum dihapus (opsional)
# - Kirim notifikasi Telegram sebelum & sesudah penghapusan
# - Guard keamanan ganda (secrets + kondisi)
# - Log lengkap untuk audit
#
# REQUIREMENTS:
# 1. Secret: DELETE_REPO_TOKEN (GitHub PAT dengan scope delete_repo)
# 2. Secret: ENABLE_AUTO_DELETE (set "true" untuk mengaktifkan)
# 3. Secret: TELEGRAM_BOT_TOKEN (opsional, untuk notifikasi)
# 4. Secret: TELEGRAM_CHAT_ID (opsional, untuk notifikasi)
# ============================================

name: ðŸ—‘ï¸ Auto Delete Repository

on:
  workflow_run:
    workflows: ["ðŸš€ DKN Compute Runtime (5 Parallel Runners - Shared Wallets)"]
    types:
      - completed

permissions:
  contents: read
  actions: read

jobs:
  # ============================================
  # JOB 1: BACKUP (OPSIONAL)
  # ============================================
  backup:
    name: ðŸ“¦ Backup Repository
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event.workflow_run.conclusion == 'failure'
    
    steps:
      - name: ðŸ“‹ Workflow Info
        run: |
          echo "============================================"
          echo "ðŸ” WORKFLOW TRIGGER INFO"
          echo "============================================"
          echo "Triggered by: ${{ github.event.workflow_run.name }}"
          echo "Conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo "Run ID: ${{ github.event.workflow_run.id }}"
          echo "Run Number: ${{ github.event.workflow_run.run_number }}"
          echo "Repository: ${{ github.repository }}"
          echo "Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "============================================"
      
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history untuk backup lengkap
      
      - name: ðŸ“¦ Create Backup Archive
        run: |
          echo "ðŸ“¦ Creating backup archive..."
          
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          TIMESTAMP=$(date -u '+%Y%m%d_%H%M%S')
          BACKUP_NAME="${REPO_NAME}_backup_${TIMESTAMP}"
          
          echo "Backup name: ${BACKUP_NAME}.tar.gz"
          
          # Backup seluruh repository (exclude .git untuk menghemat space)
          tar -czf "${BACKUP_NAME}.tar.gz" \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='*.log' \
            .
          
          # Info
          BACKUP_SIZE=$(du -h "${BACKUP_NAME}.tar.gz" | cut -f1)
          echo "âœ… Backup created: ${BACKUP_NAME}.tar.gz (${BACKUP_SIZE})"
          
          # Save untuk step selanjutnya
          echo "backup_file=${BACKUP_NAME}.tar.gz" >> $GITHUB_ENV
      
      - name: ðŸ’¾ Upload Backup to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: repository-backup-${{ github.run_id }}
          path: ${{ env.backup_file }}
          retention-days: 30  # Simpan 30 hari
          compression-level: 0  # Sudah di-compress dengan tar.gz
      
      - name: âœ… Backup Complete
        run: |
          echo "âœ… Backup uploaded to GitHub Artifacts"
          echo "ðŸ“ Artifact name: repository-backup-${{ github.run_id }}"
          echo "â° Retention: 30 days"
          echo "ðŸ”— Download URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  # ============================================
  # JOB 2: DELETE REPOSITORY
  # ============================================
  delete_repository:
    name: ðŸ—‘ï¸ Delete Repository
    runs-on: ubuntu-latest
    needs: backup  # Tunggu backup selesai dulu
    if: always()  # Jalankan meskipun backup gagal
    
    steps:
      - name: ðŸ” Check Delete Conditions
        id: check
        env:
          ENABLE_DELETE: 'true'
          DELETE_TOKEN: ${{ secrets.DELETE_REPO_TOKEN }}
          WORKFLOW_CONCLUSION: ${{ github.event.workflow_run.conclusion }}
        run: |
          echo "ðŸ” Checking delete conditions..."
          echo "============================================"
          
          # Check 1: ENABLE_AUTO_DELETE harus "true"
          if [ "$ENABLE_DELETE" != "true" ]; then
            echo "ðŸ”’ Auto-delete is DISABLED"
            echo "   Set secret ENABLE_AUTO_DELETE='true' to enable"
            echo "should_delete=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "âœ… Check 1: Auto-delete is ENABLED"
          
          # Check 2: DELETE_REPO_TOKEN harus ada
          if [ -z "$DELETE_TOKEN" ]; then
            echo "âŒ Check 2 FAILED: DELETE_REPO_TOKEN secret not found"
            echo "should_delete=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "âœ… Check 2: DELETE_REPO_TOKEN exists"
          
          # Check 3: Workflow conclusion harus success atau failure
          if [ "$WORKFLOW_CONCLUSION" != "success" ] && [ "$WORKFLOW_CONCLUSION" != "failure" ]; then
            echo "âš ï¸  Check 3: Workflow conclusion is '$WORKFLOW_CONCLUSION' (not success/failure)"
            echo "should_delete=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "âœ… Check 3: Workflow concluded with '$WORKFLOW_CONCLUSION'"
          
          echo ""
          echo "============================================"
          echo "âœ… ALL CHECKS PASSED - Repository will be deleted"
          echo "============================================"
          echo "should_delete=true" >> $GITHUB_OUTPUT
      
      - name: ðŸ“± Send Pre-Delete Telegram Notification
        if: steps.check.outputs.should_delete == 'true'
        env:
          BOT_TOKEN: '8323138901:AAFSUPd0MNzWfNORP58Th5eN7jv8OpiWgKM'
          CHAT_ID: '1051378557'
        run: |
          if [ -z "$BOT_TOKEN" ] || [ -z "$CHAT_ID" ]; then
            echo "âš ï¸  Telegram not configured, skipping notification"
            exit 0
          fi
          
          REPO_URL="https://github.com/${{ github.repository }}"
          CONCLUSION="${{ github.event.workflow_run.conclusion }}"
          
          if [ "$CONCLUSION" = "success" ]; then
            STATUS_ICON="âœ…"
            STATUS_TEXT="Completed Successfully"
          else
            STATUS_ICON="âŒ"
            STATUS_TEXT="Failed"
          fi
          
          MESSAGE="ðŸ—‘ï¸ *REPOSITORY DELETE WARNING*

          âš ï¸ Repository akan dihapus dalam 30 detik!
          
          *REPOSITORY INFO*
          â”œâ”€ Repo: \`${{ github.repository }}\`
          â”œâ”€ URL: $REPO_URL
          â””â”€ Workflow Status: $STATUS_ICON $STATUS_TEXT
          
          *DELETE INFO*
          â”œâ”€ Triggered by: Workflow completed
          â”œâ”€ Backup: Tersimpan di artifacts
          â”œâ”€ Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          â””â”€ Run: #${{ github.run_number }}
          
          â° Penghapusan akan dilakukan otomatis...
          
          ðŸ”— [View Backup](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=true \
            -d text="$MESSAGE" > /dev/null
          
          echo "âœ… Pre-delete notification sent"
      
      - name: â³ Countdown Before Delete
        if: steps.check.outputs.should_delete == 'true'
        run: |
          echo "â³ Waiting 30 seconds before deletion..."
          echo "   (Grace period untuk cancel manual jika diperlukan)"
          
          for i in {30..1}; do
            echo "   â±ï¸  $i seconds remaining..."
            sleep 1
          done
          
          echo "âœ… Countdown complete. Proceeding with deletion..."
      
      - name: ðŸ—‘ï¸ Delete Repository
        if: steps.check.outputs.should_delete == 'true'
        env:
          DELETE_TOKEN: ${{ secrets.DELETE_REPO_TOKEN }}
        run: |
          echo "============================================"
          echo "ðŸ—‘ï¸ DELETING REPOSITORY"
          echo "============================================"
          
          OWNER=$(echo "${{ github.repository }}" | cut -d'/' -f1)
          REPO=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          
          echo "Repository: ${OWNER}/${REPO}"
          echo "Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          
          # Perform DELETE request
          echo "âš ï¸  Executing DELETE request..."
          HTTP_RESPONSE=$(curl -s -w "\n%{http_code}" -X DELETE \
            -H "Authorization: token ${DELETE_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${OWNER}/${REPO}")
          
          HTTP_CODE=$(echo "$HTTP_RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$HTTP_RESPONSE" | head -n-1)
          
          echo ""
          echo "HTTP Status Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" -eq 204 ]; then
            echo "âœ… Repository successfully deleted"
            echo "deletion_status=success" >> $GITHUB_ENV
          elif [ "$HTTP_CODE" -eq 404 ]; then
            echo "âš ï¸  Repository not found (may already be deleted)"
            echo "deletion_status=not_found" >> $GITHUB_ENV
          elif [ "$HTTP_CODE" -eq 403 ]; then
            echo "âŒ Permission denied - Check DELETE_REPO_TOKEN permissions"
            echo "deletion_status=permission_denied" >> $GITHUB_ENV
            exit 1
          else
            echo "âŒ Deletion failed with HTTP $HTTP_CODE"
            echo "Response: $RESPONSE_BODY"
            echo "deletion_status=failed" >> $GITHUB_ENV
            exit 1
          fi
          
          echo "============================================"
      
      - name: ðŸ“± Send Post-Delete Telegram Notification
        if: always() && steps.check.outputs.should_delete == 'true'
        env:
          BOT_TOKEN: '8323138901:AAFSUPd0MNzWfNORP58Th5eN7jv8OpiWgKM'
          CHAT_ID: '1051378557'
        run: |
          if [ -z "$BOT_TOKEN" ] || [ -z "$CHAT_ID" ]; then
            exit 0
          fi
          
          DELETION_STATUS="${{ env.deletion_status }}"
          
          if [ "$DELETION_STATUS" = "success" ]; then
            ICON="âœ…"
            TITLE="REPOSITORY DELETED"
            STATUS_TEXT="Repository berhasil dihapus"
          elif [ "$DELETION_STATUS" = "not_found" ]; then
            ICON="âš ï¸"
            TITLE="REPOSITORY NOT FOUND"
            STATUS_TEXT="Repository sudah tidak ada"
          elif [ "$DELETION_STATUS" = "permission_denied" ]; then
            ICON="âŒ"
            TITLE="PERMISSION DENIED"
            STATUS_TEXT="Token tidak memiliki permission"
          else
            ICON="âŒ"
            TITLE="DELETION FAILED"
            STATUS_TEXT="Gagal menghapus repository"
          fi
          
          MESSAGE="$ICON *$TITLE*

          *REPOSITORY*
          â””â”€ \`${{ github.repository }}\`
          
          *STATUS*
          â””â”€ $STATUS_TEXT
          
          *BACKUP*
          â”œâ”€ Artifact ID: \`repository-backup-${{ github.run_id }}\`
          â”œâ”€ Retention: 30 days
          â””â”€ Size: Check artifacts
          
          *INFO*
          â”œâ”€ Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          â”œâ”€ Triggered by: Workflow completion
          â””â”€ Run: #${{ github.run_number }}
          
          ðŸ“¦ Backup masih tersedia di GitHub Artifacts"
          
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d parse_mode="Markdown" \
            -d text="$MESSAGE" > /dev/null
      
      - name: ðŸ“Š Final Summary
        if: always()
        run: |
          echo "============================================"
          echo "ðŸ“Š DELETE WORKFLOW SUMMARY"
          echo "============================================"
          echo "Should Delete: ${{ steps.check.outputs.should_delete }}"
          echo "Deletion Status: ${{ env.deletion_status }}"
          echo "Backup Artifact: repository-backup-${{ github.run_id }}"
          echo "Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "============================================"